### Builder

FROM golang:1.20-alpine3.17 as builder

RUN apk update
RUN apk add --no-cache make

WORKDIR /usr/src/kubearmor-relay-server

COPY . .

RUN make

### Copy executable image

FROM redhat/ubi9-minimal

ARG VERSION="latest"

LABEL name="kubearmor-relay-server" \
      vendor="AccuKnox" \
      version=${VERSION} \
      release=${VERSION} \
      summary="kubearmor-relay container image based on redhat ubi" \
      description="kubearmor relay server collects and shares all messages, \
      alerts, and system logs generated by KubeArmor in each node, streamlining log integration with other systems."

RUN microdnf -y update && \
      microdnf -y install --nodocs --setopt=install_weak_deps=0 --setopt=keepcache=0 shadow-utils && \
      microdnf clean all

RUN groupadd --gid 1000 default \
      && useradd --uid 1000 --gid default --shell /bin/bash --create-home default

COPY LICENSE /licenses/license.txt
COPY --from=builder /usr/src/kubearmor-relay-server/kubearmor-relay-server /KubeArmor/kubearmor-relay-server

USER default

ENTRYPOINT ["/KubeArmor/kubearmor-relay-server"]
