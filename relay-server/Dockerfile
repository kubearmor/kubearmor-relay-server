### Builder

FROM golang:1.20-alpine3.17 as builder

RUN apk update
RUN apk add --no-cache make

WORKDIR /usr/src/kubearmor-relay-server

COPY . .

RUN cd relay-server && make
RUN GRPC_HEALTH_PROBE_VERSION=v0.4.15 && \
    wget -qO/bin/grpc_health_probe https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/${GRPC_HEALTH_PROBE_VERSION}/grpc_health_probe-linux-amd64 && \
    chmod +x /bin/grpc_health_probe

### Copy executable image

FROM redhat/ubi9-minimal

ARG VERSION="latest"

LABEL name="kubearmor-relay-server" \
      vendor="AccuKnox" \
      version=${VERSION} \
      release=${VERSION} \
      summary="kubearmor-relay container image based on redhat ubi" \
      description="kubearmor relay server collects and shares all messages, \
      alerts, and system logs generated by KubeArmor in each node, streamlining log integration with other systems."

RUN microdnf -y update && \
    microdnf -y install --nodocs --setopt=install_weak_deps=0 --setopt=keepcache=0 shadow-utils && \
    microdnf clean all

RUN groupadd --gid 1000 default \
  && useradd --uid 1000 --gid default --shell /bin/bash --create-home default

COPY LICENSE /licenses/license.txt
COPY --from=builder /usr/src/kubearmor-relay-server/relay-server/kubearmor-relay-server /KubeArmor/kubearmor-relay-server
COPY --from=builder /bin/grpc_health_probe ./grpc_health_probe

USER default

ENTRYPOINT ["/KubeArmor/kubearmor-relay-server"]
